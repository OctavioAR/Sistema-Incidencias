CREATE DATABASE IF NOT EXISTS bdincidencias CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE bdincidencias;

CREATE TABLE Edificio (
    idEdificio INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(10) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Aula (
    idAula INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(10) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL,
    idEdificio INT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idEdificio) REFERENCES Edificio(idEdificio) ON DELETE CASCADE
);

CREATE TABLE Departamento (
    idDepartamento INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    idEdificio INT,
    idAula INT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idEdificio) REFERENCES Edificio(idEdificio) ON DELETE SET NULL,
    FOREIGN KEY (idAula) REFERENCES Aula(idAula) ON DELETE SET NULL
);

CREATE TABLE TipoUsuario (
    idTipoUsuario INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    descripcion VARCHAR(255)
);

CREATE TABLE TipoEquipo (
    idTipoEquipo INT AUTO_INCREMENT PRIMARY KEY,
    codigo CHAR(1) NOT NULL UNIQUE,
    nombre VARCHAR(50) NOT NULL,
    descripcion VARCHAR(255)
);

CREATE TABLE Usuario (
    idUsuario INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    apellidoPat VARCHAR(100) NOT NULL,
    apellidoMat VARCHAR(100),
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    idDepartamento INT,
    idTipoUsuario INT NOT NULL,
    activo TINYINT(1) DEFAULT 1,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idDepartamento) REFERENCES Departamento(idDepartamento) ON DELETE SET NULL,
    FOREIGN KEY (idTipoUsuario) REFERENCES TipoUsuario(idTipoUsuario)
);

CREATE TABLE Equipo (
    idEquipo INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(20) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL,
    marca VARCHAR(100),
    modelo VARCHAR(100),
    noSerie VARCHAR(100) UNIQUE,
    idTipoEquipo INT,
    sistemaOperativo VARCHAR(100),
    procesador VARCHAR(100),
    ram_gb INT,
    almacenamiento_gb INT,
    direccion_ip VARCHAR(15),
    direccion_mac VARCHAR(17),
    fechaCompra DATE,
    expiracionGarantia DATE,
    idDepartamento INT,
    idAula INT,
    idResponsable INT,
    estado ENUM('activo', 'mantenimiento', 'baja', 'obsoleto', 'en_stock') DEFAULT 'activo',
    fechaUltimoMantenimiento DATE NULL,
    fechaBaja DATE NULL,
    activo TINYINT(1) DEFAULT 1,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_modificacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (idTipoEquipo) REFERENCES TipoEquipo(idTipoEquipo),
    FOREIGN KEY (idDepartamento) REFERENCES Departamento(idDepartamento) ON DELETE CASCADE,
    FOREIGN KEY (idAula) REFERENCES Aula(idAula) ON DELETE SET NULL,
    FOREIGN KEY (idResponsable) REFERENCES Usuario(idUsuario) ON DELETE SET NULL
);

CREATE TABLE Software (
    idSoftware INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    version VARCHAR(50),
    fabricante VARCHAR(100),
    tipoLicencia ENUM('Libre', 'Comercial', 'Educativa', 'Prueba'),
    fechaExpiracionLicencia DATE NULL,
    requiereActivacion TINYINT(1) DEFAULT 0,
    comentarios TEXT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EquipoSoftware (
    idEquipoSoftware INT AUTO_INCREMENT PRIMARY KEY,
    idEquipo INT,
    idSoftware INT,
    fechaInstalacion DATE,
    licenciaKey VARCHAR(255) NULL,
    usuarioInstalacion VARCHAR(100),
    comentarios TEXT,
    FOREIGN KEY (idEquipo) REFERENCES Equipo(idEquipo) ON DELETE CASCADE,
    FOREIGN KEY (idSoftware) REFERENCES Software(idSoftware) ON DELETE CASCADE
);

CREATE TABLE ContratoMantenimiento (
    idContrato INT AUTO_INCREMENT PRIMARY KEY,
    idEquipo INT,
    proveedor VARCHAR(100),
    numeroContrato VARCHAR(100),
    contactoProveedor VARCHAR(100),
    telefonoContacto VARCHAR(20),
    emailContacto VARCHAR(100),
    fechaInicio DATE,
    fechaFin DATE,
    costo DECIMAL(10,2),
    cobertura TEXT,
    estado ENUM('Vigente', 'Vencido', 'Cancelado', 'Pendiente') DEFAULT 'Vigente',
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idEquipo) REFERENCES Equipo(idEquipo) ON DELETE CASCADE
);

CREATE TABLE TipoRelacion (
    idTipoRelacion INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    descripcion VARCHAR(255),
    inversa VARCHAR(50)
);

CREATE TABLE RelacionCI (
    idRelacion INT AUTO_INCREMENT PRIMARY KEY,
    idCIOrigen INT NOT NULL,
    tipoCIOrigen ENUM('equipo', 'software', 'aula', 'edificio', 'usuario', 'departamento') NOT NULL,
    idCIDestino INT NOT NULL,
    tipoCIDestino ENUM('equipo', 'software', 'aula', 'edificio', 'usuario', 'departamento') NOT NULL,
    idTipoRelacion INT,
    fechaCreacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    usuarioCreacion INT,
    comentarios TEXT,
    FOREIGN KEY (idTipoRelacion) REFERENCES TipoRelacion(idTipoRelacion),
    FOREIGN KEY (usuarioCreacion) REFERENCES Usuario(idUsuario)
);

CREATE TABLE TipoIncidencia (
    idTipoIncidencia INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL UNIQUE,
    descripcion VARCHAR(255)
);

CREATE TABLE EstadoIncidencia (
    idEstadoIncidencia INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    descripcion VARCHAR(255)
);

CREATE TABLE Incidencia (
    idIncidencia INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(255) NOT NULL,
    descripcion TEXT NOT NULL,
    idEstadoIncidencia INT DEFAULT 1,
    idTipoIncidencia INT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    fecha_cierre TIMESTAMP NULL,
    idUsuarioReporta INT,
    idEquipo INT,
    idTecnicoAsignado INT NULL,
    idDepartamento INT,
    prioridad ENUM('baja', 'media', 'alta', 'critica') DEFAULT 'media',
    comentarios_cierre TEXT,
    FOREIGN KEY (idEstadoIncidencia) REFERENCES EstadoIncidencia(idEstadoIncidencia),
    FOREIGN KEY (idTipoIncidencia) REFERENCES TipoIncidencia(idTipoIncidencia),
    FOREIGN KEY (idUsuarioReporta) REFERENCES Usuario(idUsuario),
    FOREIGN KEY (idEquipo) REFERENCES Equipo(idEquipo) ON DELETE SET NULL,
    FOREIGN KEY (idTecnicoAsignado) REFERENCES Usuario(idUsuario) ON DELETE SET NULL,
    FOREIGN KEY (idDepartamento) REFERENCES Departamento(idDepartamento) ON DELETE CASCADE
);

CREATE TABLE HistorialIncidencia (
    idHistorial INT AUTO_INCREMENT PRIMARY KEY,
    idIncidencia INT,
    idEstadoAnterior INT,
    idEstadoNuevo INT,
    idUsuarioCambio INT,
    fecha_cambio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    comentario TEXT,
    FOREIGN KEY (idIncidencia) REFERENCES Incidencia(idIncidencia) ON DELETE CASCADE,
    FOREIGN KEY (idEstadoAnterior) REFERENCES EstadoIncidencia(idEstadoIncidencia),
    FOREIGN KEY (idEstadoNuevo) REFERENCES EstadoIncidencia(idEstadoIncidencia),
    FOREIGN KEY (idUsuarioCambio) REFERENCES Usuario(idUsuario)
);

-- ==============================================================
-- INSERCIONES DE EJEMPLO
-- ==============================================================

INSERT IGNORE INTO TipoUsuario (nombre, descripcion) VALUES 
('Administrador', 'Acceso completo al sistema'),
('Jefe de Taller', 'Gestiona incidencias y asigna técnicos'),
('Técnico', 'Resuelve incidencias asignadas'),
('Maestro', 'Reporta incidencias');

INSERT IGNORE INTO EstadoIncidencia (nombre, descripcion) VALUES 
('Enviado', 'Incidencia reportada, pendiente de revisión'),
('Revisión Jefe', 'En revisión por el jefe de taller'),
('Rechazado', 'Incidencia rechazada por el jefe'),
('Asignado', 'Incidencia asignada a un técnico'),
('En Proceso', 'Técnico trabajando en la incidencia'),
('Liberado', 'Incidencia resuelta y verificada'),
('Cerrado', 'Incidencia completamente finalizada');

INSERT IGNORE INTO TipoIncidencia (nombre, descripcion) VALUES 
('Mantenimiento Correctivo', 'Reparación de equipo dañado'),
('Mantenimiento Preventivo', 'Mantenimiento programado'),
('Falla Hardware', 'Problema con componentes físicos'),
('Falla Software', 'Problema con programas o sistema operativo'),
('Solicitud de Equipo', 'Solicitud de nuevo equipo');

INSERT IGNORE INTO TipoEquipo (codigo, nombre, descripcion) VALUES 
('C', 'Computadora', 'Equipo de cómputo de escritorio o laptop'),
('P', 'Proyector', 'Proyector de video'),
('I', 'Impresora', 'Impresora de cualquier tipo'),
('S', 'Switch', 'Equipo de networking'),
('R', 'Router', 'Router de red'),
('M', 'Monitor', 'Monitor de computadora');

INSERT IGNORE INTO TipoRelacion (nombre, descripcion, inversa) VALUES 
('conectado_a', 'Conexión física entre dispositivos', 'conectado_desde'),
('instalado_en', 'Software instalado en hardware', 'tiene_instalado'),
('ubicado_en', 'Dispositivo ubicado en un espacio físico', 'contiene'),
('pertenece_a', 'Relación de propiedad o responsabilidad', 'tiene_a_cargo'),
('depende_de', 'Dependencia funcional entre elementos', 'es_requerido_por'),
('utilizado_por', 'Recurso utilizado por una persona', 'usa');

INSERT IGNORE INTO Edificio (codigo, nombre) VALUES 
('EA', 'Edificio A - Sistemas'),
('EB', 'Edificio B - Sistemas'),
('EC', 'Edificio C - Sistemas'),
('ED', 'Edificio D - Bioquimica');

INSERT IGNORE INTO Aula (codigo, nombre, idEdificio) VALUES 
('A01', 'Aula 01', 1),
('A02', 'Aula 02', 1),
('LP', 'Laboratorio de Programación', 2),
('A03', 'Aula 03', 1),
('L02', 'Laboratorio de Química', 4),
('C01', 'Aula 01', 3),
('C04', 'Aula 04', 3),
('B01', 'Aula 01', 2);

INSERT IGNORE INTO Departamento (nombre, idEdificio, idAula) VALUES 
('Ingeniería en Sistemas', 1, 2),
('Ingeniería en Sistemas', 2, 3),
('Ingeniería Bioquímica', 4, 5);

INSERT IGNORE INTO Usuario (nombre, apellidoPat, apellidoMat, email, password, idTipoUsuario, idDepartamento) VALUES 
('Admin', 'Sistema', '', 'admin@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 1, 3),
('Juan', 'Pérez', 'Gómez', 'juan.perez@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 2, 3),
('María', 'López', 'Hernández', 'maria.lopez@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 3, 1),
('Carlos', 'García', 'Martínez', 'carlos.garcia@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 3, 1),
('Ana', 'Rodríguez', 'Sánchez', 'ana.rodriguez@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 4, 1),
('Pedro', 'Martínez', 'Díaz', 'pedro.martinez@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 4, 2),
('Laura', 'González', 'Vázquez', 'laura.gonzalez@universidad.edu', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 4, 3);

INSERT IGNORE INTO Software (nombre, version, fabricante, tipoLicencia, fechaExpiracionLicencia, requiereActivacion) VALUES 
('Windows 10', '21H2', 'Microsoft', 'Comercial', '2024-12-31', 1),
('Windows 11', '22H2', 'Microsoft', 'Comercial', '2025-06-30', 1),
('Microsoft Office', '2021', 'Microsoft', 'Comercial', '2024-10-15', 1),
('Adobe Photoshop', 'CC 2023', 'Adobe', 'Comercial', '2024-08-20', 1),
('Visual Studio Code', '1.74', 'Microsoft', 'Libre', NULL, 0),
('Python', '3.11', 'Python Software Foundation', 'Libre', NULL, 0),
('Google Chrome', '108', 'Google', 'Libre', NULL, 0);

INSERT IGNORE INTO Equipo (codigo, nombre, marca, modelo, noSerie, idTipoEquipo, sistemaOperativo, procesador, ram_gb, almacenamiento_gb, direccion_ip, direccion_mac, fechaCompra, expiracionGarantia, idDepartamento, idAula, idResponsable, estado) VALUES 
('EAA01C001', 'Computadora Profesor', 'Dell', 'OptiPlex 3090', 'DEL123456', 1, 'Windows 10', 'Intel i5-10500', 8, 256, '192.168.1.10', '00:1A:2B:3C:4D:10', '2023-01-15', '2025-01-15', 1, 1, 5, 'activo'),
('EAA01P001', 'Proyector Aula 01', 'Epson', 'EB-U05', 'EPS789012', 2, 'N/A', 'N/A', NULL, NULL, NULL, '00:1B:2C:3D:4E:20', '2023-02-20', '2025-02-20', 1, 1, 5, 'activo'),
('EALPC001', 'Laptop Laboratorio', 'HP', 'EliteBook 840', 'HP345678', 1, 'Windows 11', 'Intel i7-1165G7', 16, 512, '192.168.1.50', '00:1C:2D:3E:4F:30', '2023-03-10', '2025-03-10', 1, 3, 1, 'activo'),
('EDL02I001', 'Impresora Color', 'Canon', 'PIXMA MX492', 'CAN901234', 3, 'N/A', 'N/A', NULL, NULL, '192.168.1.100', '00:1D:2E:3F:40:50', '2023-04-05', '2025-04-05', 3, 5, 2, 'activo'),
('EALPS001', 'Switch Red', 'Cisco', 'Catalyst 2960', 'CIS567890', 4, 'IOS', 'N/A', NULL, NULL, '192.168.1.1', '00:1E:2F:40:51:60', '2023-05-12', '2025-05-12', 1, 3, 1, 'activo'),
('EALPC002', 'Computadora Estudiante', 'Lenovo', 'ThinkCentre M75q', 'LEN135790', 1, 'Windows 10', 'AMD Ryzen 5', 8, 256, '192.168.1.51', '00:1F:30:41:52:70', '2023-06-18', '2025-06-18', 1, 3, 1, 'mantenimiento');

INSERT IGNORE INTO EquipoSoftware (idEquipo, idSoftware, fechaInstalacion, licenciaKey, usuarioInstalacion) VALUES 
(1, 1, '2023-01-20', 'ABCDE-12345-FGHIJ-67890', 'Admin'),
(1, 3, '2023-01-20', 'OFFICE-2021-12345', 'Admin'),
(1, 7, '2023-01-21', NULL, 'Admin'),
(3, 2, '2023-03-15', 'W11PRO-67890-KLMNO', 'Admin'),
(3, 3, '2023-03-15', 'OFFICE-2021-67890', 'Admin'),
(3, 5, '2023-03-16', NULL, 'Admin'),
(3, 6, '2023-03-16', NULL, 'Admin'),
(6, 1, '2023-06-20', 'WIN10-54321-STUVI', 'Admin'),
(6, 7, '2023-06-20', NULL, 'Admin');

INSERT IGNORE INTO ContratoMantenimiento (idEquipo, proveedor, numeroContrato, contactoProveedor, telefonoContacto, emailContacto, fechaInicio, fechaFin, costo, cobertura, estado) VALUES 
(1, 'Dell México', 'CTO-DELL-2023-001', 'Ing. Roberto Martínez', '555-123-4567', 'roberto.martinez@dell.com', '2023-01-15', '2025-01-15', 2500.00, 'Garantía extendida: hardware y soporte técnico', 'Vigente'),
(2, 'Epson Service', 'CTO-EPSON-2023-002', 'Lic. Sofia Ramírez', '555-987-6543', 'sofia.ramirez@epson.com', '2023-02-20', '2025-02-20', 1800.00, 'Mantenimiento preventivo y correctivo', 'Vigente'),
(4, 'Canon Support', 'CTO-CANON-2023-003', 'Téc. Javier López', '555-456-7890', 'javier.lopez@canon.com', '2023-04-05', '2025-04-05', 1200.00, 'Soporte técnico y suministros', 'Vigente');

INSERT IGNORE INTO RelacionCI (idCIOrigen, tipoCIOrigen, idCIDestino, tipoCIDestino, idTipoRelacion, usuarioCreacion, comentarios) VALUES 
(2, 'equipo', 1, 'equipo', 1, 1, 'Proyector conectado a computadora del profesor'),
(1, 'equipo', 1, 'aula', 3, 1, 'Computadora ubicada en Aula 01'),
(2, 'equipo', 1, 'aula', 3, 1, 'Proyector ubicado en Aula 01'),
(3, 'equipo', 3, 'aula', 3, 1, 'Laptop ubicada en Laboratorio de Programación'),
(4, 'equipo', 5, 'aula', 3, 1, 'Impresora ubicada en Laboratorio de Química'),
(5, 'equipo', 3, 'aula', 3, 1, 'Switch ubicado en Laboratorio de Programación'),
(6, 'equipo', 3, 'aula', 3, 1, 'Computadora estudiante ubicada en Laboratorio de Programación'),
(1, 'equipo', 5, 'usuario', 4, 1, 'Computadora asignada al profesor Ana Rodríguez'),
(3, 'equipo', 1, 'usuario', 4, 1, 'Laptop asignada al administrador'),
(5, 'equipo', 3, 'departamento', 4, 1, 'Switch pertenece al departamento de Sistemas');

INSERT IGNORE INTO Incidencia (titulo, descripcion, idTipoIncidencia, idUsuarioReporta, idEquipo, idDepartamento, prioridad) VALUES 
('Proyector no enciende', 'El proyector del aula 01 no responde al encendido', 3, 5, 2, 1, 'alta'),
('Computadora lenta', 'La computadora del profesor tarda mucho en abrir programas', 4, 5, 1, 1, 'media'),
('Impresora atasca papel', 'La impresora de administración atasca papel constantemente', 1, 7, 4, 3, 'media'),
('No hay conexión a internet', 'En el laboratorio de sistemas no hay conexión a internet desde hoy', 3, 6, 5, 1, 'alta'),
('Tecla de laptop descompuesta', 'La tecla Enter de la laptop del laboratorio no funciona', 3, 5, 3, 1, 'baja');

UPDATE Incidencia SET idTecnicoAsignado = 3, idEstadoIncidencia = 4 WHERE idIncidencia = 1;
UPDATE Incidencia SET idTecnicoAsignado = 4, idEstadoIncidencia = 4 WHERE idIncidencia = 2;
UPDATE Incidencia SET idTecnicoAsignado = 3, idEstadoIncidencia = 4 WHERE idIncidencia = 4;

INSERT IGNORE INTO HistorialIncidencia (idIncidencia, idEstadoAnterior, idEstadoNuevo, idUsuarioCambio, comentario) VALUES 
(1, 1, 4, 2, 'Asignado al técnico María López'),
(2, 1, 4, 2, 'Asignado al técnico Carlos García'),
(4, 1, 4, 2, 'Asignado al técnico María López por urgencia');

